services:

  discovery:             # Discovery
    build:
      context: ..
      dockerfile: modules/discovery/Dockerfile
    container_name: discovery
    ports:
      - "8761:8761"
    environment:
      # Standalone Eureka server â€“ no need to register with other peers
      - EUREKA_CLIENT_REGISTER_WITH_EUREKA=false
      - EUREKA_CLIENT_FETCH_REGISTRY=false


  gateway:              # Gateway
    build:
      context: ..
      dockerfile: modules/gateway/Dockerfile
    container_name: gateway
    depends_on:
      - discovery
      - user-service
      - movie-service
      - rating-service
    environment:    # Set env variables for service
      - EUREKA_DEFAULT_ZONE=http://discovery:8761/eureka/          # Route resolution via Eureka:
    ports:
      - "8081:8081"


  user-db:                                 # User Database Service (Container)
    image: postgres:18
    container_name: pg-user          # optional, keeps your old name
    restart: unless-stopped
    environment:
      POSTGRES_DB: userdb           # matches your Spring config
      POSTGRES_USER: user
      POSTGRES_PASSWORD: user
    ports:
      - "5434:5432"                 # host:container, matches jdbc://localhost:5434
    volumes:
      - pg_user_data:/var/lib/postgresql
      # named volume so data persists even if container is removed

  user-service:                         # User Service (Container)
    build:
      context: ..                       # repo root (one level up from docker/)
      dockerfile: modules/user-service/Dockerfile               # path from repo root to the Dockerfile
    container_name: user-service
    restart: unless-stopped
    depends_on:
      - user-db
      - discovery
    environment:
      - SPRING_DATASOURCE_URL=jdbc:postgresql://user-db:5432/userdb
      - SPRING_DATASOURCE_USERNAME=user
      - SPRING_DATASOURCE_PASSWORD=user

      - EUREKA_DEFAULT_ZONE=http://discovery:8761/eureka/      # Eureka client: point to discovery server in Docker
    ports:
      - "8082:8082"                     # host:container


  movie-db:                         # Movie Database Service (Container)
    image: postgres:18
    container_name: pg-movie
    restart: unless-stopped
    environment:
      POSTGRES_DB: moviedb
      POSTGRES_USER: movie
      POSTGRES_PASSWORD: movie
    ports:
      - "5435:5432"
    volumes:
      - pg_movie_data:/var/lib/postgresql
      # named volume so data persists even if container is removed

  movie-service:                    # Movie Service (Container)
    build:
      context: ..                       # repo root (one level up from docker/)
      dockerfile: modules/movie-service/Dockerfile               # path from repo root to the Dockerfile
    container_name: movie-service
    restart: unless-stopped
    depends_on:
      - movie-db
      - discovery
    environment:
      - SPRING_DATASOURCE_URL=jdbc:postgresql://movie-db:5432/moviedb
      - SPRING_DATASOURCE_USERNAME=movie
      - SPRING_DATASOURCE_PASSWORD=movie

      - EUREKA_DEFAULT_ZONE=http://discovery:8761/eureka/      # Eureka config: point to discovery server in Docker

      - TMDB_BASE_URL=https://api.themoviedb.org/3
      - TMDB_API_KEY=${TMDB_API_KEY}                              # Retrieve from .env
      - MOVIE_TMDB_SEED_ENABLED=${MOVIE_TMDB_SEED_ENABLED}
    ports:
      - "8083:8083"                     # host:container


  rating-db:                        # Rating Database Service (Container)
    image: postgres:18
    container_name: pg-rating
    restart: unless-stopped
    environment:
      POSTGRES_DB: ratingdb
      POSTGRES_USER: rating
      POSTGRES_PASSWORD: rating
    ports:
      - "5436:5432"
    volumes:
      - pg_rating_data:/var/lib/postgresql
      # named volume so data persists even if container is removed

  rating-service:                   # Rating Service (Container)
    build:
      context: ..                       # repo root (one level up from docker/)
      dockerfile: modules/rating-service/Dockerfile               # path from repo root to the Dockerfile
    container_name: rating-service
    restart: unless-stopped
    depends_on:
      - rating-db
      - discovery
    environment:
      - SPRING_DATASOURCE_URL=jdbc:postgresql://rating-db:5432/ratingdb
      - SPRING_DATASOURCE_USERNAME=rating
      - SPRING_DATASOURCE_PASSWORD=rating

      - EUREKA_DEFAULT_ZONE=http://discovery:8761/eureka/      # Eureka config: point to discovery server in Docker

    ports:
      - "8084:8084"                     # host:container



  frontend:                       # FRONTEND
    build:
      context: ../frontend
      dockerfile: Dockerfile
    container_name: frontend
    ports:
      - "3000:3000"
    environment:
      NODE_ENV: production
      NEXT_PUBLIC_API_BASE_URL: ${NEXT_PUBLIC_API_BASE_URL}
    depends_on:
      - gateway








volumes:
  pg_user_data:
  pg_movie_data:
  pg_rating_data:










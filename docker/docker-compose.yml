services:
  user-db:                                 # Database Service (Container)
    image: postgres:18
    container_name: pg-user          # optional, keeps your old name
    restart: unless-stopped
    environment:
      POSTGRES_DB: userdb           # matches your Spring config
      POSTGRES_USER: user
      POSTGRES_PASSWORD: user
    ports:
      - "5434:5432"                 # host:container, matches jdbc://localhost:5434
    volumes:
      - pg_user_data:/var/lib/postgresql
      # named volume so data persists even if container is removed

  user-service:                         # User Service (Container)
    build:
      context: ..                       # repo root (one level up from docker/)
      dockerfile: modules/user-service/Dockerfile               # path from repo root to the Dockerfile
    container_name: user-service
    restart: unless-stopped
    depends_on:
      - user-db
    environment:
      - SPRING_DATASOURCE_URL=jdbc:postgresql://user-db:5432/userdb
      - SPRING_DATASOURCE_USERNAME=user
      - SPRING_DATASOURCE_PASSWORD=user
      - EUREKA_DEFAULT_ZONE=http://discovery:8761/eureka/      # Eureka client: point to discovery server in Docker
    ports:
      - "8082:8082"                     # host:container

  gateway:
    build:
      context: ..
      dockerfile: modules/gateway/Dockerfile
    container_name: gateway
    depends_on:
      - user-service
    environment:    # Set env variables for service
      - EUREKA_DEFAULT_ZONE=http://discovery:8761/eureka/          # Route resolution via Eureka:
    ports:
      - "8081:8081"

  discovery:
    build:
      context: ..
      dockerfile: modules/discovery/Dockerfile
    container_name: discovery
    ports:
      - "8761:8761"
    environment:
      # Standalone Eureka server â€“ no need to register with other peers
      - EUREKA_CLIENT_REGISTER_WITH_EUREKA=false
      - EUREKA_CLIENT_FETCH_REGISTRY=false

volumes:
  pg_user_data:









